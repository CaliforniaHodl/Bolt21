name: Security Check

on:
  # Weekly on Monday at 9am UTC
  schedule:
    - cron: '0 9 * * 1'

  # Manual trigger with mode selection
  workflow_dispatch:
    inputs:
      mode:
        description: 'Check mode'
        required: true
        default: 'weekly'
        type: choice
        options:
          - weekly
          - monthly
          - quarterly

jobs:
  security-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Determine check mode
        id: mode
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # Weekly on scheduled runs
            echo "mode=weekly" >> $GITHUB_OUTPUT
          else
            echo "mode=${{ inputs.mode }}" >> $GITHUB_OUTPUT
          fi

      - name: Run security checks
        id: security
        run: |
          chmod +x scripts/security-check.sh
          ./scripts/security-check.sh ${{ steps.mode.outputs.mode }} 2>&1 | tee security-output.txt
        continue-on-error: true

      - name: Check for outdated dependencies
        run: flutter pub outdated

      - name: Run security tests
        run: flutter test test/security/ || true

      - name: Run full test suite
        if: steps.mode.outputs.mode != 'weekly'
        run: flutter test

      - name: Upload security report
        if: steps.mode.outputs.mode == 'quarterly'
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: docs/security/reports/

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let output = '';
            try {
              output = fs.readFileSync('security-output.txt', 'utf8');
            } catch (e) {
              output = 'Security check failed. See workflow logs.';
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Security Check Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `## Security Check Failed\n\n**Mode:** ${{ steps.mode.outputs.mode }}\n**Run:** ${context.runId}\n\n### Output\n\`\`\`\n${output.slice(-2000)}\n\`\`\`\n\n### Action Required\nReview the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) and fix any issues.`,
              labels: ['security', 'automated']
            });

      - name: Notify on success (quarterly)
        if: success() && steps.mode.outputs.mode == 'quarterly'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Quarterly Security Check Complete - ${new Date().toISOString().split('T')[0]}`,
              body: `## Quarterly Security Review Complete\n\nAll automated checks passed.\n\n### Next Steps\n- [ ] Review the security report artifact\n- [ ] Update threat model if needed\n- [ ] Schedule red team engagement if not done this quarter\n\n### Report\nDownload from [workflow artifacts](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}).`,
              labels: ['security', 'review-needed']
            });

  # Separate job for monthly checks on first of month
  monthly-trigger:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    outputs:
      is_monthly: ${{ steps.check.outputs.is_monthly }}
    steps:
      - name: Check if first Monday of month
        id: check
        run: |
          DAY=$(date +%d)
          if [ "$DAY" -le 7 ]; then
            echo "is_monthly=true" >> $GITHUB_OUTPUT
          else
            echo "is_monthly=false" >> $GITHUB_OUTPUT
          fi

  monthly-check:
    needs: monthly-trigger
    if: needs.monthly-trigger.outputs.is_monthly == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run monthly security checks
        run: |
          chmod +x scripts/security-check.sh
          ./scripts/security-check.sh monthly

  # CVE monitoring job
  dependency-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Check outdated packages
        id: outdated
        run: |
          flutter pub outdated > outdated.txt 2>&1 || true
          cat outdated.txt

          # Check for major updates in security-critical packages
          if grep -E "(flutter_secure_storage|cryptography|bip39)" outdated.txt | grep -q "major"; then
            echo "critical_update=true" >> $GITHUB_OUTPUT
          else
            echo "critical_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Alert on critical updates
        if: steps.outdated.outputs.critical_update == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const outdated = fs.readFileSync('outdated.txt', 'utf8');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Critical Dependency Update Available - ${new Date().toISOString().split('T')[0]}`,
              body: `## Security-Critical Package Update\n\nA major version update is available for a security-critical package.\n\n### Outdated Packages\n\`\`\`\n${outdated}\n\`\`\`\n\n### Action Required\n1. Review the changelog for security fixes\n2. Test thoroughly before updating\n3. Update and run full security check`,
              labels: ['security', 'dependencies']
            });
